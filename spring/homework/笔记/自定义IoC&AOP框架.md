------



# 自定义IoC&AOP框架

## 1 IoC

### 1.1 什么是IoC

- IoC（Inversion of Control）：控制反转，是一种技术思想，不是技术实现

- 描述的事情：Java开发领域对象的创建和管理问题

- IoC开发方式：由IoC容器实例化对象并且管理对象，使用对象时去IoC容器中获取

- 控制反转：

    - 控制：指对象创建（实例化、管理）的权力
    
    - 反转：控制权交给外部环境（Spring框架、IoC容器）

### 1.2 IoC解决什么问题

- IoC解决对象之间的耦合问题

### 1.3 IoC和DI的区别

- DI（Dependency Injection）：依赖注入

- 区别：描述同一个事情（对象实例化及依赖关系维护），只不过角度不同

    - IoC是在对象的角度，对象实例化及管理的权力交给了（反转）容器
    
    - DI是在容器的角度，容器会把对象依赖的其他对象注入，例如A对象在实例化过程中声明了B对象，则需要容器把B对象注入给A对象

## 2 AOP

### 2.1 什么是AOP

- AOP（Aspect Oriented Programming）：面向切面编程，是OOP的延续

- OOP（Object Oriented Programming）：面向对象

    - 三大特征：封装、继承、多态
    
    - 垂直继承体系
    
    - 可以使用继承解决大多数代码重复问题，但有些情况除外，如在顶级父类中出现代码重复

### 2.2 AOP解决的问题

- 横切逻辑代码：在多个纵向（顺序）流程中出现的相同子流程代码

    - 使用场景：事务控制、权限校验、日志记录
    
    - 存在问题：
    
        - 横切代码重复
        
        - 横切逻辑代码与业务代码混在一起，代码臃肿，不便维护
        
    - 问题解决：AOP提出横向抽取机制，将横切逻辑代码与业务代码分离。在不改变原有业务逻辑的情况下，增强横切逻辑代码，根本上解耦合，避免横切逻辑代码重复

### 2.3 面向切面编程

- 切：横切逻辑，原有业务逻辑不变，只能操作横切代码，所以面向横切逻辑

- 面：横切逻辑往往影响多个方法，每个方法为一个点，多点构成面

## 3 手写实现IoC和AOP

### 3.1 问题分析（例如Service层和Dao层）

- new关键字将Service层的实现类与Dao层的实现类耦合在一起，当需要切换Dao层实现类时需要手动需改Service层代码，不符合面向接口开发的最优原则

- Service层没有添加事务控制，出现异常将会出现数据不一致为问题

### 3.2 new关键字耦合问题解决

- 使用反射实例化对象，Class.forName("全限定类名")，将全限定类名配置在xml文件中

- 使用工厂设计模式来生产对象，工厂类读取解析xml文件，通过反射实例化对象，并向外提供获取对象的接口方法

### 3.3 事务控制问题解决

- 分析：

    - 数据库事务归根结底是Connection的事务
    
        - connection.commit()：事务提交
        
        - connection.rollback()：事务回滚
        
    - 多次数据库操作使用不同的Connection，不属于同一个事务控制
    
    - 事务应该在Service层控制
    
- 解决思路：

    - 多次数据库操作使用同一个Connection连接
    
        - 给当前线程绑定一个Connection对象，当前线程所执行的数据库操作都使用线程绑定的Connection对象
        
    - 把事务控制在Service层