------



# Spring AOP高级应用与源码分析

## 1 Spring AOP基础知识

### 1.1 AOP本质

- 在不改变原有业务逻辑的情况下增强横切逻辑，横切逻辑代码往往是权限校验、日志、事务控制、性能监控

### 1.2 AOP相关术语

- JoinPoint(连接点)：可以用于把增强代码加入到业务主线的点（方法开始、结束、异常等特殊的时机点），连接点是一种候选点

- Pointcut(切入点)：指定AOP方法具体影响的方法

- Advice（通知/增强）：前置通知、后置通知、异常通知、最终通知、环绕通知

    - 第一个层次：指横切逻辑
    
    - 第二个层次：方位点（在某些连接点上加入横切逻辑）
    
- Target（目标对象）：指代理的目标对象，即被代理对象

- Proxy（代理）:一个类被AOP织入增强后产生的代理，即代理对象

- Weaving（织入）：把增强应用到目标对象来创建新的代理对象的过程。Spring采用动态代理织入，而Aspectj采用编译期织入和类装载织入

- Aspect（切面）：切面是对上述概念的综合

    - 切面 = 切入点（锁定方法） + 方位点（绑定方法中的特殊时机） + 横切逻辑

### 1.3 代理选择

- 默认情况下，Spring会根据被代理对象是否实现接⼝来选择使⽤JDK还是CGLIB。当被代理对象没有实现
  任何接⼝时，Spring会选择CGLIB。当被代理对象实现了接⼝，Spring会选择JDK官⽅的代理技术，不过
  我们可以通过配置的⽅式，让Spring强制使⽤CGLIB。

### 1.4 配置方式

- 使⽤XML配置

- 使⽤XML+注解组合配置

- 使⽤纯注解配置

## 2 Spring声明式事务 

### 2.1 事务概念

- 事务：逻辑上的一组操作，要么全部成功，要么全部失败，从而保证数据的一致性

- 编程式事务：在业务代码中添加事务控制代码，这样的事务控制方式称为编程式事务

- 声明式事务：通过xml或注解配置的方式达到事务控制的目的，称为声明式事务

### 2.2 事务四大特性

- 原子性

- 一致性

- 隔离性

- 持久性

### 2.3 事务隔离级别

- 解决事务并发问题：

    - 脏读
    
    - 不可重复读
    
    - 幻读

- 四大隔离级别

    - | 隔离级别 | 说明 |
      | :-----| :---- |
      | Serializable | 避免脏读、不可重复读、幻读 |
      | RepeatableRead | 避免脏读、不可重复度 |
      | ReadCommitted | 避免脏读 |
      | ReadUnCommitted | 脏读、不可重复读、幻读均无法保证 |
    
- MySQL默认隔离级别：RepeatableRead

### 2.4 事务传播行为

-   | 传播行为 | 说明 |
    | :-----| :---- |
    | PROPAGATION_REQUIRED | 如果当前没有事务，就新建⼀个事务，如果已经存在⼀个事务中，加⼊到这个事务 |
    | PROPAGATION_SUPPORTS | ⽀持当前事务，如果当前没有事务，就以⾮事务⽅式执⾏ |
    | PROPAGATION_MANDATORY | 使⽤当前的事务，如果当前没有事务，就抛出异常 |
    | PROPAGATION_REQUIRES_NEW | 新建事务，如果当前存在事务，把当前事务挂起 |
    | PROPAGATION_NOT_SUPPORTED | 以⾮事务⽅式执⾏操作，如果当前存在事务，就把当前事务挂起 |
    | PROPAGATION_NEVER | 以⾮事务⽅式执⾏，如果当前存在事务，则抛出异常 |
    | PROPAGATION_NESTED | 如果当前存在事务，则在嵌套事务内执⾏。如果当前没有事务，则执⾏与PROPAGATION_REQUIRED类似的操作 |

### 2.5 Spring事务API

- PlatformTransactionManager：Spring事务管理器核心接口，不支持事务实现，只负责提供标准

- TransactionDefinition：事务定义（描述）的对象，提供了事务相关信息获取的方法

- TransactionStatus：事务的状态，描述了某一时间点上事务的状态信息

