------



# Dubbo深入配置和高级实战

## 1 SPI

### 1.1 SPI简介

- SPI 全称为 (Service Provider Interface) ，是JDK内置的一种服务提供发现机制。使用SPI机制的优势是实现解耦，使得第三方服务模块的装配控制逻辑与调用者的业务代码分离

### 1.2 JDK中的SPI

- 当服务提供者提供了接口的一种具体实现后，在META-INF/services目录下创建一个以“接口全限定名”为命名的文件，内容为实现类的全限定名

- 接口实现类所在的jar包放在主程序的classpath中

- 主程序通过java.util.ServiceLoader动态装载实现模块，它通过扫描META-INF/services目录下的配置文件找到实现类的全限定名，把类加载到JVM

- SPI的实现类必须携带一个无参构造方法

### 1.3 Dubbo中的SPI

- JDK 标准的 SPI 会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源

- 如果有扩展点加载失败，则所有扩展点无法使用

- 提供了对扩展点包装的功能(Adaptive)，并且还支持通过set的方式对其他的扩展点进行注入

### 1.4 Dubbo SPI中的Adaptive功能

- 主要解决的问题是如何动态的选择具体的扩展点。通过getAdaptiveExtension 统一对指定接口对应的所有扩展点进行封装，通过URL的方式对扩展点来进行动态选择。 (dubbo中所有的注册信息都是通过URL的形式进行处理的)这里同样采用相同的方式进行实现

### 1.5 Dubbo调用时拦截操作

- Dubbo的Filter机制，是专门为服务提供方和服务消费方调用过程进行拦截设计的，每次远程方法执行，该拦截都会被执行。这样就为开发者提供了非常方便的扩展性，比如为dubbo接口实现ip白名单功能、监控功能 、日志记录等

## 2 负载均衡策略

### 2.1 负载均衡策略

- Random LoadBalance

    - 随机，按权重设置随机概率

    - 在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重

- RoundRobin LoadBalance

    - 轮询，按公约后的权重设置轮询比率

    - 存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上

- LeastActive LoadBalance

    - 最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差

    - 使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大

- ConsistentHash LoadBalance

    - 一致性 Hash，相同参数的请求总是发到同一提供者

    - 当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动

## 3 异步调用

### 3.1 异步调用

- Dubbo不只提供了堵塞式的的同步调用，同时提供了异步调用的方式。这种方式主要应用于提供者接口响应耗时明显，消费者端可以利用调用接口的时间去做一些其他的接口调用,利用Future 模式来异步等待和获取结果即可。这种方式可以大大的提升消费者端的利用率。 目前这种方式可以通过XML的方式进行引入

## 4 线程池

### 4.1 线程池

- dubbo在使用时，都是通过创建真实的业务线程池进行操作的

- fix: 表示创建固定大小的线程池。也是Dubbo默认的使用方式，默认创建的执行线程数为200，并且是没有任何等待队列的。所以再极端的情况下可能会存在问题，比如某个操作大量执行时，可能存在堵塞的情况。后面也会讲相关的处理办法

- cache: 创建非固定大小的线程池，当线程不足时，会自动创建新的线程。但是使用这种的时候需要注意，如果突然有高TPS的请求过来，方法没有及时完成，则会造成大量的线程创建，对系统的CPU和负载都是压力，执行越多反而会拖慢整个系统

## 5 路由规则

### 5.1 路由规则

- 路由是决定一次请求中需要发往目标机器的重要判断，通过对其控制可以决定请求的目标机器

- 本质上就是通过在zookeeper中保存一个节点数据，来记录路由规则。消费者会通过监听这个服务的路径，来感知整个服务的路由规则配置，然后进行适配

## 6 服务动态降级

### 6.1 什么是服务降级

- 服务降级，当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务有策略的降低服务级别，以释放服务器资源，保证核心任务的正常运行

### 6.2 为什么要服务降级

- 防止分布式服务发生雪崩效应

- 当一个请求发生超时，一直等待着服务响应，那么在高并发情况下，很多请求都是因为这样一直等着响应，直到服务资源耗尽产生宕机，而宕机之后会导致分布式其他服务调用该宕机的服务也会出现资源耗尽宕机，这样下去将导致整个分布式服务都瘫痪，这就是雪崩

### 6.3 服务降级实现方式

- 在 dubbo 管理控制台配置服务降级

    - 屏蔽：表示消费方对该服务的方法调用都直接返回 null 值，不发起远程调用。用来屏蔽不重要服务不可用时对调用方的影响
    
    - 容错：表示消费方对该服务的方法调用在失败后，再返回 null 值，不抛异常。用来容忍不重要服务不稳定时对调用方的影响

- 指定返回简单值或者null

- 使用java代码动态写入配置中心