------



# 一致性Hash问题及解决方案

## 1 分布式和集群

### 1.1 概念

- 分布式一定是集群，集群不一定是分布式（因为集群是多个实例一起工作，分布式拆分系统后就是多个实例；集群不一定是分布式，因为复制型的集群不是拆分而是复制）

- 分布式：把一个系统拆分为多个子系统，每个子系统负责各自的一部分工作，独立部署

- 集群：多个实例共同工作，最简单的集群是将一个应用复制多份部署

## 2 一致性Hash算法

### 2.1 为什么使用Hash

- Hash算法较多的应⽤在数据存储和查找领域，最经典的就是Hash表，它的查询效率⾮常之⾼，其中的哈希算法如果设计的⽐较好，那么Hash表的数据查询时间复杂度可以接近于O(1)

### 2.2 Hash算法应用场景

- Hash算法在很多分布式集群产品中都有应⽤，⽐如分布式集群架构Redis、Hadoop、ElasticSearch，Mysql分库分表，Nginx负载均衡等

- 应用场景：

    - 请求的负载均衡（⽐如nginx的ip_hash策略）
    
    - 分布式存储（Redis集群）

### 2.3 普通Hash算法存在的问题

- 当容器大小发生变化，取模后的数据也将发生变化

### 2.4 ⼀致性Hash算法

- ⾸先有⼀条直线，直线开头和结尾分别定为为1和2的32次⽅减1，这相当于⼀个地址，对于这样⼀条线，弯过来构成⼀个圆环形成闭环，这样的⼀个圆环称为hash环。然后把服务器的ip或者主机名求hash值然后对应到hash环上，那么针对客户端⽤户，也根据它的ip进⾏hash求值，对应到环上某个位置，按照顺时针⽅向找最近的服务器节点。增加和删除节点只影响一小部分数据。

- ⼀致性哈希算法在服务节点太少时，容易因为节点分部不均匀⽽造成数据倾斜问题，大量请求落在一个节点上。解决这种数据倾斜问题，⼀致性哈希算法引⼊了虚拟节点机制，即对每⼀个服务节点计算多个哈希，每个计算结果位置都放置⼀个此服务节点，称为虚拟节点。当客户端被路由到虚拟节点的时候其实是被路由到该虚拟节点所对应的真实节点。
