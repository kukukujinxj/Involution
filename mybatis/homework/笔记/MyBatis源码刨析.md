------



# MyBatis源码刨析

## 1 架构

### 1.1 接口层

- 提供给外部使用的接口API，开发人员通过这些本地API来操纵数据库。接口层一接收到调用请求就会调用数据处理层来完成具体的数据处理。

    - 交互模式
    
        - 使用传统的MyBatis提供的API
        
        - 使用Mapper代理的方式

### 1.2 数据处理层

- 负责具体的SQL查找、SQL解析、SQL执行和执行结果映射处理等。主要的目的是根据调用的请求完成一次数据库操作。

### 1.3 框架支撑层

- 负责最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，这些都是共用的东西，将它们抽取出来作为最基础的组件，为上层的数据处理层提供最基础的支撑。

## 2 总体流程

### 2.1 加载配置并初始化

- 触发条件：加载配置文件

- 配置来源：配置文件（SqlMapConfig.xml和Mapper.xml）和Java注解。将配置文件内容分别加载解析封装到Configuration和MappedStatement对象中。

### 2.2 接收调用请求

- 触发条件：调用MyBatis提供的API

- 传入参数：SQL的ID和出入参数对象

- 处理过程：将请求传递给下层处理

### 2.3 处理操作请求

- 触发条件：API接口层传递过来的请求

- 传入参数：SQL的ID和出入参数对象

- 处理过程：

    - 根据SQL的ID查找MappedStatement对象
    
    - 根据传入参数解析MappedStatement对象，得到最终执行的SQL和参数
    
    - 获取数据库连接，执行SQL并得到结果
    
    - 根据MappedStatement对象中的映射结果进行转换处理，并得到最终结果
    
    - 释放连接资源

### 2.4 返回结果集

- 将最终结果返回